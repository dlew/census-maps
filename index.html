<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #map_canvas { height: 100% }
</style>
<script type="text/javascript"
    src="http://maps.google.com/maps/api/js?sensor=false">
</script>
<script type="text/javascript" src="data.js"></script>
<script type="text/javascript">
// Controlling variables
// This determines the max opacity a gradient can have when comparing neighborhoods
// Theoretically when you do a comparison, the highest neighborhood
// should have this gradient
var MAX_OPACITY = .9;

// Data driving the script
var Data = {};

// References for each neighborhood
Data.NH = {
	BANCROFT: "Bancroft",
	BRYANT: "Bryant",
    CARAG: "CARAG",
    CENTRAL: "Central",
    CORCORAN: "Corcoran",
    ECCO: "ECCO",
    EAST_ISLES: "EastIsles",
    KING_FIELD: "KingField",
    LYNDALE: "Lyndale",
    LOWRY_HILL: "LowryHill",
    LOWRY_HILL_EAST: "LowryHillEast",
    PHILLIPS: "Phillips",
    POWDERHORN_PARK: "PowderhornPark",
    STANDISH: "Standish",
    STEVENS_SQ_LORING_HGTS: "StevensSquareLoringHeights",
    VENTURA_VILLAGE: "VenturaVillage",
    WHITTIER: "Whittier",
}

// Initial point data - should only be used once each
// to initialize each region
Data.NH_POINTS = {};
Data.NH_POINTS[Data.NH.BANCROFT] = [
	44.926936, -93.26251,
	44.934137, -93.26251,
	44.934122, -93.24734,
	44.926906, -93.247318,
];
Data.NH_POINTS[Data.NH.BRYANT] = [
	44.926891, -93.274612,
	44.934091, -93.274655,
	44.934152, -93.262489,
	44.926921, -93.26251,
	44.926845, -93.27002,
	44.926754, -93.271351,
];
Data.NH_POINTS[Data.NH.CARAG] = [
    44.948357, -93.298275,
    44.948353, -93.288109,
    44.937676, -93.288227,
    44.937684, -93.298382
];
Data.NH_POINTS[Data.NH.CENTRAL] = [
	44.948338, -93.274806,
	44.948338, -93.262682,
	44.934152, -93.262446,
	44.934122, -93.274655,
];
Data.NH_POINTS[Data.NH.CORCORAN] = [
	44.937722, -93.247383,
	44.948368, -93.247404,
	44.948353, -93.238285,
	44.937646, -93.231118,
];
Data.NH_POINTS[Data.NH.ECCO] =  [
    44.948338, -93.298259,
    44.937676, -93.298345,
    44.937646, -93.304009,
    44.943114, -93.30358,
    44.948399, -93.306327
];
Data.NH_POINTS[Data.NH.EAST_ISLES] = [
    44.948353, -93.29828,
    44.948368, -93.304954,
    44.951026, -93.304996,
    44.952833, -93.302314,
    44.953623, -93.301992,
    44.954154, -93.30152,
    44.955126, -93.301156,
    44.955642, -93.30137,
    44.956022, -93.301971,
    44.956402, -93.30313,
    44.956766, -93.303452,
    44.957859, -93.303173,
    44.960198, -93.30122,
    44.96082, -93.30122,
    44.960896, -93.292787,
    44.955506, -93.2968,
    44.952241, -93.298302,
];
Data.NH_POINTS[Data.NH.KING_FIELD] = [
	44.919545, -93.288324,
	44.937691, -93.288217,
	44.937722, -93.274698,
	44.919644, -93.274698,
];
Data.NH_POINTS[Data.NH.LYNDALE] = [
	44.948353, -93.288109,
	44.948338, -93.274806,
	44.937752, -93.274655,
	44.937676, -93.288217,
];
Data.NH_POINTS[Data.NH.LOWRY_HILL] = [
	44.96082, -93.301392,
	44.963098, -93.303838,
	44.963265, -93.303773,
	44.963249, -93.303301,
	44.966407, -93.30328,
	44.966422, -93.304524,
	44.968108, -93.304567,
	44.968563, -93.304052,
	44.969094, -93.302486,
	44.969216, -93.299181,
	44.968897, -93.297873,
	44.969094, -93.296499,
	44.969869, -93.295469,
	44.969808, -93.29047,
	44.969064, -93.290191,
	44.968882, -93.288217,
	44.966392, -93.28856,
	44.960911, -93.292766,
]
Data.NH_POINTS[Data.NH.LOWRY_HILL_EAST] = [
    44.948368, -93.29828,
    44.952241, -93.298259,
    44.955521, -93.296757,
    44.962703, -93.291392,
    44.966483, -93.288195,
    44.948353, -93.288109,
];
Data.NH_POINTS[Data.NH.PHILLIPS] = [
	44.948293, -93.274806,
	44.949796, -93.274591,
	44.951952, -93.273346,
	44.956143, -93.269935,
	44.957328, -93.269527,
	44.960911, -93.269484,
	44.960896, -93.262553,
	44.959104, -93.262553,
	44.959142, -93.249861,
	44.960942, -93.24985,
	44.960775, -93.247619,
	44.957358, -93.244185,
	44.955551, -93.24307,
	44.951907, -93.240838,
	44.948353, -93.23822,
];
Data.NH_POINTS[Data.NH.POWDERHORN_PARK] = [
	44.948353, -93.262639,
	44.948353, -93.247404,
	44.934091, -93.24734,
	44.934137, -93.262467,
];
Data.NH_POINTS[Data.NH.STANDISH] = [
	44.925098, -93.246052,
	44.926906, -93.246052,
	44.926906, -93.247318,
	44.937691, -93.247383,
	44.937707, -93.231118,
	44.926921, -93.223672,
	44.926875, -93.232126,
	44.925068, -93.232126,
];
Data.NH_POINTS[Data.NH.STEVENS_SQ_LORING_HGTS] = [
	44.962688, -93.287991,
	44.965352, -93.288023,
	44.964699, -93.287187,
	44.964373, -93.286361,
	44.964267, -93.285577,
	44.964327, -93.284547,
	44.964358, -93.284343,
	44.96643, -93.276125,
	44.966559, -93.274409,
	44.966551, -93.273475,
	44.96583, -93.269988,
	44.962703, -93.269999,
];
Data.NH_POINTS[Data.NH.VENTURA_VILLAGE] = [
	44.96085, -93.26957,
	44.965785, -93.269763,
	44.965921, -93.255215,
	44.966255, -93.249979,
	44.960911, -93.245816,
	44.959696, -93.246911,
	44.960896, -93.248348,
	44.960911, -93.24985,
	44.95915, -93.249872,
	44.959104, -93.262575,
	44.960911, -93.262532,
];
Data.NH_POINTS[Data.NH.WHITTIER] = [
	44.962688, -93.288002,
	44.962718, -93.27002,
	44.956872, -93.269999,
	44.956219, -93.270257,
	44.953471, -93.272402,
	44.951011, -93.274355,
	44.949416, -93.275042,
	44.948338, -93.27517,
	44.948338, -93.288109,
];


// Filled by initializeNeighborhoods()
Data.NH_Polys = {};

// Stored elements
var elInfoTable;

function initialize() {
    var latlng = new google.maps.LatLng(44.942263, -93.287144);
    var myOptions = {
        zoom: 13,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    Data.map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

    google.maps.event.addListener(Data.map, 'click', function() {
        // Deselect a neighborhood if user clicks somewhere off the map
        if (lastNeighborhood) {
            deselectNeighborhood(lastNeighborhood);
        }
    });

    initializeNeighborhoods();

    elInfoTable = document.getElementById("infotable");
}

var initializeNeighborhoods = function() {
    for (var nh in Data.NH_POINTS) {
        var points = Data.NH_POINTS[nh];
        var gLatLngs = [];
        for (var a = 0; a < points.length; a += 2) {
            gLatLngs[gLatLngs.length] = new google.maps.LatLng(points[a], points[a + 1]);
        }
        Data.NH_Polys[nh] = new google.maps.Polygon({
            paths: gLatLngs,
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF0000",
            fillOpacity: 0.35,
            map: Data.map
        });

        var fun = (function() {
            var name = nh;
            return function() {
                selectNeighborhood(name);
            };
        })();

        google.maps.event.addListener(Data.NH_Polys[nh], 'click', fun);
    }
};

var lastNeighborhood;
var selectNeighborhood = function(name) {
    // Deselect the previous neighborhood
    if (lastNeighborhood) {
        if (lastNeighborhood === name) {
            return;
        }
        deselectNeighborhood(lastNeighborhood);
    }

    // Set the color of the selected neighborhood
    Data.NH_Polys[name].setOptions({
        strokeColor: "#0000FF",
        fillColor: "#0000FF",
    });

    // Setup the info box on the right
    var data = NH_DATA[name];

    // Temporarily remove box while manipulating DOM
    var tableParent = elInfoTable.parentNode;
    tableParent.removeChild(elInfoTable);

    var tableBody = document.createElement("tbody");

    // Add new data
    for (var index = 0; index < NH_SPEC.length; index++) {
        var field = NH_SPEC[index];

        var row = document.createElement("tr");

        var subjectCell = document.createElement("td");
        var subjectCellText = document.createTextNode(field["desc"]);
        subjectCell.appendChild(subjectCellText);

        var valueCell = document.createElement("td");
        var valueCellText = document.createTextNode(data[field["field"]]);
        valueCell.appendChild(valueCellText);

        row.appendChild(subjectCell);
        row.appendChild(valueCell);
        tableBody.appendChild(row);
    }

    elInfoTable.appendChild(tableBody);

    // Re-add the info table to the DOM
    tableParent.appendChild(elInfoTable);

    // Set the last neighborhood
    lastNeighborhood = name;
}

var deselectNeighborhood = function(name) {
    Data.NH_Polys[name].setOptions({
        strokeColor: "#FF0000",
        fillColor: "#FF0000",
    });

    while (elInfoTable.childNodes.length > 0) {
        elInfoTable.removeChild(elInfoTable.childNodes[0]);
    }
}

var compareNeighborhoods = function(el) {
    switch(el.selectedIndex) {
        case 0:
            // Reset all neighborhoods
            for (var poly in Data.NH_Polys) {
                Data.NH_Polys[poly].setOptions({
                    fillOpacity: 0.35
                });
            }
            break;
        case 1:
            // Compare population
            simpleComparison("pop_total");
            break;
        case 2:
            // Compare female population
            normalizedComparison("pop_female", "pop_total");
            break;
        case 3:
            // Compare children under 6
            normalizedComparison("pop_children", "pop_total");
            break;
        case 4:
            // Compare mean commute time
            simpleComparison("commute_mean");
            break;
        case 5:
            // Compare median household income
            simpleComparison("income_hh_median");
            break;
        case 6:
            // Compare median family income
            simpleComparison("income_family_median");
            break;
    }
}

var simpleComparison = function(fieldName) {
    var max = -1;
    for (var nameKey in Data.NH) {
    	var val = NH_DATA[Data.NH[nameKey]][fieldName];
        if (val > max) {
        	max = val;
        }
    }

    for (var nameKey in Data.NH) {
        var name = Data.NH[nameKey];
        Data.NH_Polys[name].setOptions({
            fillOpacity: ((NH_DATA[name][fieldName] / max) * MAX_OPACITY)
        });
    }
}

var normalizedComparison = function(fieldName, normalizerFieldName) {
	var max = -1;
    for (var nameKey in Data.NH) {
        var data = NH_DATA[Data.NH[nameKey]]
        var val = data[fieldName] / data[normalizerFieldName];
        if (val > max) {
        	max = val;
        }
    }

    for (var nameKey in Data.NH) {
        var name = Data.NH[nameKey];
        var data = NH_DATA[Data.NH[nameKey]]
        var percent = data[fieldName] / data[normalizerFieldName];
        Data.NH_Polys[name].setOptions({
            fillOpacity: ((percent / max) * MAX_OPACITY)
        });
    }
}
</script>
</head>
<body onload="initialize()">
  <table style="width: 100%; height: 100%">
    <tr style="height: 1px">
        <td colspan="2"><h1>Minneapolis Census Map</h1></td>
    </tr>
    <tr style="height: 1px">
        <td colspan="2">
        	Compare neighborhood data:
            <select onchange="compareNeighborhoods(this);">
                <option></option>
                <option>Population</option>
                <option>% Female population</option>
                <option>% Children under 6</option>
                <option>Mean travel time</option>
                <option>Median household income</option>
                <option>Median family income</option>
            </select>
        </td>
    </tr>
    <tr>
        <td style="width:70%"><div id="map_canvas" style="width:100%; height:100%"></div></td>
        <td><table id="infotable"></table></td>
    </tr>
  </table>
</body>
</html>
